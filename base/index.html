<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360 Virtual Tour Editor</title>
    <style>
        body {
            margin: 0;
            display: flex;
            height: 100vh;
            font-family: Arial, sans-serif;
        }

        #sidebar {
            width: 250px;
            background: #f4f4f4;
            overflow-y: auto;
            border-right: 1px solid #ccc;
            padding: 15px;
        }

        #playground {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            flex-direction: column;
        }

        #panorama-container {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: space-between;
        }

        #panorama {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #pannellum-container {
    flex: 1;
    position: relative; /* Ensures the panorama is positioned correctly */
    z-index: 1; /* Keeps the panorama behind the hotspot container */
}

        .hotspot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: red;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .hotspot:hover,
        .hotspot.selected {
            transform: scale(1.5);
            background: yellow;
        }

        .controls {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        #hotspot-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            padding: 10px;
        }

        .hotspot-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .hotspot-item:hover,
        .hotspot-item.selected {
            background-color: #e0e0e0;
        }
    
 

/* If you want the container's content (like hotspots) to be absolutely positioned */
#hotspot-container {
    position: absolute; /* Float on top of the panorama viewer */
    top: 0;
    left: 0;
    width: 50%; /* Make it take up the full width of the panorama */
    height: 50%; /* Make it take up the full height of the panorama */
    background-size: contain; /* Ensures the entire image is visible */
    background-position: center; /* Centers the image in the container */
    background-repeat: no-repeat; /* Prevents the image from repeating */
    pointer-events: none; /* Allows clicks through the hotspot container */
    z-index: 2; /* Ensures it stays above the panorama */
}

    </style>
</head>

<body>
    <div id="sidebar">
        <h2>Images</h2>
        <div id="image-list"></div>

        <h2>Hotspots</h2>
        <div id="hotspot-list"></div>
    </div>

    <div id="playground">

            <div id="hotspot-container"></div>
 
             <div id="pannellum-container"></div>
        <div class="controls">
            <div class="control-group">
                <label>Pitch</label>
                <input type="range" id="pitch-slider" min="-90" max="90" value="0">
                <span id="pitch-value">0</span>
            </div>
            <div class="control-group">
                <label>Yaw</label>
                <input type="range" id="yaw-slider" min="-180" max="180" value="0">
                <span id="yaw-value">0</span>
            </div>
            <button id="update-hotspot">Update Hotspot</button>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    <script>
        class VirtualTourEditor {
            constructor() {
                this.supabase = this.initSupabase();
                this.state = {
                    tours: [],
                    currentTour: null,
                    currentImage: null,
                    hotspots: [],
                    selectedHotspot: null
                };

                this.initElements();
                this.bindEvents();
            }

            initSupabase() {
                const supabaseUrl = 'https://pdkebhnxoigzhhmdvkrt.supabase.co';
                const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBka2ViaG54b2lnemhobWR2a3J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDI0MzY2NDQsImV4cCI6MjAxODAxMjY0NH0.zmBGjlfVQyZOrNCeW8io3VkVZdM34mw4w20yv6sehe8';
                return window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            }

            initElements() {
                this.elements = {
                    imageList: document.getElementById('image-list'),
                    panorama: document.getElementById('panorama'),
                    hotspotContainer: document.getElementById('hotspot-container'),
                    hotspotList: document.getElementById('hotspot-list'),
                    pitchSlider: document.getElementById('pitch-slider'),
                    yawSlider: document.getElementById('yaw-slider'),
                    pitchValue: document.getElementById('pitch-value'),
                    yawValue: document.getElementById('yaw-value'),
                    updateHotspotBtn: document.getElementById('update-hotspot'),
                    pannellumContainer: document.getElementById('pannellum-container')
                };
            }

            bindEvents() {
                this.elements.pitchSlider.addEventListener('input', this.updateSliderValue.bind(this, 'pitch'));
                this.elements.yawSlider.addEventListener('input', this.updateSliderValue.bind(this, 'yaw'));
                this.elements.updateHotspotBtn.addEventListener('click', this.updateHotspot.bind(this));
            }

            async loadTours() {
                try {
                    const { data, error } = await this.supabase
                        .from('tour_360')
                        .select('*')
                        .order('id', { ascending: true });

                    if (error) throw error;

                    this.state.tours = data;
                    this.renderTourList();
                } catch (err) {
                    console.error('Tour loading error:', err);
                }
            }

            renderTourList() {
                this.elements.imageList.innerHTML = '';
                this.state.tours.forEach(tour => {
                    const tourElement = document.createElement('div');
                    tourElement.textContent = tour.reference;
                    tourElement.addEventListener('click', () => this.selectTour(tour));
                    this.elements.imageList.appendChild(tourElement);
                });
            }

            selectTour(tour) {
                this.state.currentTour = tour;
                this.loadImages(tour);
            }

            loadImages(tour) {
                const images = tour.jsonData || [];
                this.renderImageList(images);
            }

            renderImageList(images) {
                this.elements.imageList.innerHTML = '';
                images.forEach(image => {
                    const imageElement = document.createElement('div');
                    imageElement.textContent = image.url;
                    imageElement.addEventListener('click', () => this.selectImage(image));
                    this.elements.imageList.appendChild(imageElement);
                });
            }

            selectImage(image) {
                this.state.currentImage = image;
                this.loadPanorama(image.url);
                
                this.loadHotspots(image.customHotspots || []);
            }

            loadPanorama(imageUrl) {
                this.elements.hotspotContainer.style.width = 1366.0/3.0;  // Or set a specific width
                this.elements.hotspotContainer.style.height = 768.0/3.0; // Or set a specific height
                    
                this.elements.hotspotContainer.style.backgroundImage = `url(${imageUrl})`;
                this.viewer && this.viewer.destroy();  // Destroy previous viewer instance if exists

                const viewer = pannellum.viewer('pannellum-container', {
                    type: 'equirectangular',
                    panorama: imageUrl,
                    autoLoad: true,
                    showControls: false,
                    hotSpots: [] // We'll add hotspots dynamically
                });

                // Update the current panorama viewer
                this.viewer = viewer;
            }

            loadHotspots(hotspots) {
                this.state.hotspots = hotspots;
                this.renderHotspots();
                this.renderHotspotList();
                this.addHotspotsToViewer();
            }

            addHotspotsToViewer() {
                setTimeout(() => {
                    // Create hotspots based on the state.hotspots array
                    const hotSpots = this.state.hotspots.map(hotspot => ({
                        pitch: hotspot.pitch,
                        yaw: hotspot.yaw,
                       
                        type: "info",
                        createTooltipFunc: function () {
                            return hotspot.text;
                        },
                        createTooltipArgs: []
                    }));

                    // Add each hotspot to the viewer
                    hotSpots.forEach(hotSpot => {
                        this.viewer.addHotSpot(hotSpot); // Add the individual hotspot to the viewer
                    });
                }, 1500);
            }

            renderHotspots() {
                this.elements.hotspotContainer.innerHTML = '';
                this.state.hotspots.forEach((hotspot, index) => {
                    const hotspotElement = document.createElement('div');
                    hotspotElement.classList.add('hotspot');
                    this.positionHotspot(hotspotElement, hotspot);

                    hotspotElement.addEventListener('click', () => this.selectHotspot(hotspot));
                    this.elements.hotspotContainer.appendChild(hotspotElement);
                });
            }

            renderHotspotList() {
                this.elements.hotspotList.innerHTML = '';
                this.state.hotspots.forEach((hotspot, index) => {
                    const hotspotItem = document.createElement('div');
                    hotspotItem.classList.add('hotspot-item');
                    hotspotItem.textContent = `${hotspot.text} (Yaw: ${hotspot.yaw}, Pitch: ${hotspot.pitch})`;

                    hotspotItem.addEventListener('click', () => this.selectHotspot(hotspot));
                    this.elements.hotspotList.appendChild(hotspotItem);
                });
            }

            positionHotspot(element, hotspot) {
                const container = this.elements.hotspotContainer;
                const image = this.elements.panorama;

                element.style.position = 'absolute';

                const xPercent = ((hotspot.yaw + 180) / 360) * 100;
                const yPercent = ((90 - hotspot.pitch) / 180) * 100;

                element.style.left = `${xPercent}%`;
                element.style.top = `${yPercent}%`;
                element.style.transform = 'translate(-50%, -50%)';
            }

            selectHotspot(hotspot) {
                this.state.selectedHotspot = hotspot;

                document.querySelectorAll('.hotspot, .hotspot-item').forEach(el => {
                    el.classList.remove('selected');
                });

                this.elements.pitchSlider.value = hotspot.pitch;
                this.elements.yawSlider.value = hotspot.yaw;
                this.elements.pitchValue.textContent = hotspot.pitch;
                this.elements.yawValue.textContent = hotspot.yaw;
            }

            updateSliderValue(type) {
                const slider = type === 'pitch' ? this.elements.pitchSlider : this.elements.yawSlider;
                const valueDisplay = type === 'pitch' ? this.elements.pitchValue : this.elements.yawValue;

                valueDisplay.textContent = slider.value;

                if (this.state.selectedHotspot) {
                    this.state.selectedHotspot[type] = parseFloat(slider.value);
                    this.updateHotspotPosition();
                }
            }

            updateHotspotPosition() {
                const hotspots = document.querySelectorAll('.hotspot');
                const hotspotIndex = this.state.hotspots.findIndex(h => h === this.state.selectedHotspot);

                if (hotspotIndex !== -1) {
                    const hotspotElement = hotspots[hotspotIndex];
                    this.positionHotspot(hotspotElement, this.state.selectedHotspot);
                }

                this.addHotspotsToViewer();
            }

            updateHotspot() {
                if (!this.state.selectedHotspot) return;

                // Get the new pitch and yaw values
                const pitch = parseFloat(this.elements.pitchSlider.value);
                const yaw = parseFloat(this.elements.yawSlider.value);

                // Update the hotspot's pitch and yaw values
                this.state.selectedHotspot.pitch = pitch;
                this.state.selectedHotspot.yaw = yaw;

                // Destroy the current viewer instance
                if (this.viewer) {
                    this.viewer.destroy();
                }

                // Reload the panorama
                this.loadPanorama(this.state.currentImage.url);

                // Wait for 3 seconds before adding hotspots again
                setTimeout(() => {
                    this.addHotspotsToViewer();
                }, 3000);
            }


            init() {
                this.loadTours();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const editor = new VirtualTourEditor();
            editor.init();
        });
    </script>
</body>

</html>